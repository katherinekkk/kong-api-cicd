trigger:
- main

pool:
  name: Default

stages:

# ---------------- STAGE 1: VALIDATE JSON ----------------
- stage: Validate
  displayName: Validate JSON files
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self

    - script: |
        echo "Validating JSON files in apis/ ..."
        for f in apis/*.json; do
          echo "Checking $f"
          jq empty "$f"
        done
      displayName: Validate JSON


# ---------------- STAGE 2: CONVERT TO YAML ----------------
- stage: Convert
  dependsOn: Validate
  displayName: Convert JSON to YAML
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    - script: |
        rm -rf converted-apis
        mkdir -p converted-apis

        echo "Converting JSON â†’ YAML"
        for f in apis/*.json; do
          name=$(basename "$f" .json)
          yq eval -P "$f" > "converted-apis/$name.yaml"
        done
      displayName: Convert JSON to YAML

    - publish: converted-apis
      artifact: converted-apis
      displayName: Publish converted YAML


# ---------------- STAGE 3: UPGRADE TO KONG 3.x ----------------
- stage: Upgrade
  dependsOn: Convert
  displayName: Upgrade to Kong 3.x format
  jobs:
  - job: UpgradeFormat
    steps:
    - download: current
      artifact: converted-apis

    - script: |
        rm -rf upgraded-apis
        mkdir -p upgraded-apis

        echo "Upgrading to Kong 3.x format"
        for f in "$(Pipeline.Workspace)"/converted-apis/*.yaml; do
          name=$(basename "$f" .yaml)
          deck file convert \
            --from kong-gateway-2.x \
            --to kong-gateway-3.x \
            --input-file "$f" \
            --output-file "upgraded-apis/${name}-3x.yaml"
        done
      displayName: Upgrade format to Kong 3.x

    - publish: upgraded-apis
      artifact: upgraded-apis
      displayName: Publish upgraded configs


# ---------------- STAGE 4: DEPLOY ----------------
- stage: Deploy
  dependsOn: Upgrade
  displayName: Deploy to Kong
  jobs:
  - job: DeployToKong
    steps:
    - download: current
      artifact: upgraded-apis

    - script: |
        set -e

        echo "Files for deployment:"
        ls -1 "$(Pipeline.Workspace)/upgraded-apis"

        echo "Pinging Kong..."
        deck gateway ping

        echo "Deploying ONLY 3.x YAML files..."
        for f in "$(Pipeline.Workspace)"/upgraded-apis/*-3x.yaml; do
          echo "Deploying $f"
          deck gateway sync "$f"
        done
      displayName: Deploy APIs using decK

