trigger:
- main

pool:
  name: Default   # self-hosted linux agent

stages:

# ---------- Stage 1: Validate ----------
- stage: Validate
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self

    - script: bash scripts/validate-json.sh
      displayName: Validate API JSON


# ---------- Stage 2: Convert JSON â†’ YAML ----------
- stage: Convert
  dependsOn: Validate
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    - script: bash scripts/convert-json-to-yaml.sh
      displayName: Convert JSON to YAML

    - publish: apis
      artifact: converted-apis


# ---------- Stage 3: Upgrade to Kong 3.x ----------
- stage: Upgrade
  dependsOn: Convert
  jobs:
  - job: UpgradeDeckFormat
    steps:
    - download: current
      artifact: converted-apis

    - script: |
        mkdir upgraded-apis
        for f in $(Pipeline.Workspace)/converted-apis/*.yaml; do
          name=$(basename $f .yaml)
          echo "Upgrading $name to Kong 3.x format"
          deck file convert --from kong-gateway-2.x --to kong-gateway-3.x \
            $f > upgraded-apis/${name}-3x.yaml
        done
      displayName: Upgrade decK format to Kong 3.x

    - publish: upgraded-apis
      artifact: upgraded-apis


# ---------- Stage 4: Deploy to Kong ----------
- stage: Deploy
  dependsOn: Upgrade
  jobs:
  - job: DeployToKong
    steps:
    - download: current
      artifact: upgraded-apis

    - script: |
        echo "Available files:"
        ls -R $(Pipeline.Workspace)/upgraded-apis

        FILE=$(Pipeline.Workspace)/upgraded-apis/demo-api-3x.yaml

        echo "Ensuring workspace exists in file..."
        if ! grep -q "_workspace" "$FILE"; then
          echo "_workspace: default" | cat - "$FILE" > temp && mv temp "$FILE"
        fi

        echo "Final file content:"
        cat "$FILE"

        echo "Checking Kong connectivity..."
        deck gateway ping

        echo "Deploying to Kong..."
        deck gateway sync --workspace default "$FILE"
      displayName: Deploy APIs to Kong using decK
