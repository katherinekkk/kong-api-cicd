trigger:
- main

pool:
  name: Default   # self-hosted agent

stages:

# ---------------- Stage 1 Validate JSON ----------------
- stage: Validate
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self

    - script: bash scripts/validate-json.sh
      displayName: Validate API JSON format

# ---------------- Stage 2 Convert JSON â†’ YAML ----------------
- stage: Convert
  dependsOn: Validate
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    - script: bash scripts/convert-json-to-yaml.sh
      displayName: Convert JSON to YAML

    - publish: apis
      artifact: converted-apis

# ---------------- Stage 3 Upgrade to Kong 3.x ----------------
- stage: Upgrade
  dependsOn: Convert
  jobs:
  - job: UpgradeFormat
    steps:
    - download: current
      artifact: converted-apis

    - script: |
        mkdir -p upgraded-apis
        echo "Upgrading all YAML files to Kong 3.x format..."
        for f in converted-apis/*.yaml; do
          name=$(basename "$f")
          deck file convert \
            --from kong-gateway-2.x \
            --to kong-gateway-3.x \
            --input-file "$f" \
            --output-file "upgraded-apis/$name"
        done

      displayName: Upgrade configuration to Kong 3.x

    - publish: upgraded-apis
      artifact: upgraded-apis

# ---------------- Stage 4 Deploy to Kong Gateway ----------------
- stage: Deploy
  dependsOn: Upgrade
  jobs:
  - job: DeployToKong
    steps:
    - download: current
      artifact: upgraded-apis

    - script: |
        echo "Listing files to deploy:"
        ls -l upgraded-apis

        echo "Testing connection to Kong..."
        deck gateway ping

        echo "Deploying APIs to Kong Gateway..."
        for f in upgraded-apis/*.yaml; do
          echo "Deploying $f"
          deck gateway sync "$f"
        done

      displayName: Deploy APIs to Kong using decK
