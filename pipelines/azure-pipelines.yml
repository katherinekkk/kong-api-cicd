trigger:
- main

pool:
  name: Default      # your self-hosted agent

stages:

# ---------- Stage 1: Validate ----------
- stage: Validate
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self

    - script: |
        bash scripts/validate-json.sh
      displayName: Validate JSON spec


# ---------- Stage 2: Convert JSON â†’ YAML ----------
- stage: Convert
  dependsOn: Validate
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    - script: |
        bash scripts/convert-json-to-yaml.sh
        ls -R apis
      displayName: Convert JSON to YAML

    # publish YAML output (apis/*.yaml)
    - publish: apis
      artifact: converted-apis


# ---------- Stage 3: Upgrade YAML to Kong 3.x ----------
- stage: Upgrade
  dependsOn: Convert
  jobs:
  - job: UpgradeDecK
    steps:
    - checkout: self

    # download YAML from previous stage
    - download: current
      artifact: converted-apis

    - script: |
        echo "Upgrading config to Kong 3.x"

        ls -R $(Pipeline.Workspace)/converted-apis

        deck file convert \
          --from kong-gateway-2.x \
          --to kong-gateway-3.x \
          $(Pipeline.Workspace)/converted-apis/demo-api.yaml \
          > $(Pipeline.Workspace)/converted-apis/demo-api-3x.yaml

        echo "Converted file created:"
        ls -l $(Pipeline.Workspace)/converted-apis
      displayName: Upgrade decK file format to Kong 3.x

    # publish upgraded spec
    - publish: $(Pipeline.Workspace)/converted-apis
      artifact: upgraded-apis


# ---------- Stage 4: Deploy to Kong ----------
- stage: Deploy
  dependsOn: Upgrade
  jobs:
  - job: DeployToKong
    steps:
    - checkout: self

    # download upgraded artifact
    - download: current
      artifact: upgraded-apis

    - script: |
        echo "Available files:"
        ls -R $(Pipeline.Workspace)/upgraded-apis

        echo "Pinging Kong..."
        deck gateway ping

        echo "Deploying API to Kong Gateway..."
        deck gateway sync $(Pipeline.Workspace)/upgraded-apis/demo-api-3x.yaml
      displayName: Deploy APIs to Kong using decK
