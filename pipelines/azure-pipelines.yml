trigger:
- main

pool:
  name: Default   # self-hosted agent

stages:

# ---------- Stage 1 Validate ----------
- stage: Validate
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self

    - script: bash scripts/validate-json.sh
      displayName: Validate JSON


# ---------- Stage 2 Convert ----------
- stage: Convert
  dependsOn: Validate
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    - script: bash scripts/convert-json-to-yaml.sh
      displayName: Convert JSON to YAML

    # publish converted YAML so next stage can use it
    - publish: apis
      artifact: converted-apis


# ---------- Stage 3 Upgrade to Kong 3.x ----------
- stage: Upgrade
  dependsOn: Convert
  jobs:
  - job: UpgradeDeckFormat
    steps:
    - checkout: self

    # download artifact from previous stage
    - download: current
      artifact: converted-apis

    - script: |
        echo "Upgrading config to Kong 3.x format"

        # convert old 2.x â†’ 3.x format
        deck file convert \
          --from kong-gateway-2.x \
          --to kong-gateway-3.x \
          apis/demo-api.yaml > apis/demo-api-3x.yaml

        echo "Converted file created: apis/demo-api-3x.yaml"
      displayName: Upgrade decK format to Kong 3.x


# ---------- Stage 4 Deploy ----------
- stage: Deploy
  dependsOn: Upgrade
  jobs:
  - job: DeployToKong
    steps:
    - checkout: self

    - script: |
        echo "Deploying upgraded API spec to Kong Gateway..."
        deck gateway sync apis/demo-api-3x.yaml
      displayName: Deploy APIs to Kong using decK
