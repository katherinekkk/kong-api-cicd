trigger:
- main

pool:
  name: Default

stages:

# ---------- Stage 1 Validate ----------
- stage: Validate
  jobs:
  - job: ValidateJSON
    steps:
    - checkout: self
    - script: bash scripts/validate-json.sh
      displayName: Validate API JSON

# ---------- Stage 2 Convert ----------
- stage: Convert
  dependsOn: Validate
  jobs:
  - job: ConvertToYAML
    steps:
    - checkout: self

    # Convert JSON â†’ YAML
    - script: |
        echo "Converting JSON to YAML"
        yq -p=json -o=yaml apis/demo-api.json > apis/demo-api.yaml
      displayName: Convert JSON to YAML

    # Upgrade decK format to Kong 3.x
    - script: |
        echo "Upgrading config to Kong 3.x format"
        deck file convert \
          --from kong-gateway-2.x \
          --to kong-gateway-3.x \
          --input-file apis/demo-api.yaml \
          --output-file apis/demo-api.yaml
      displayName: Upgrade decK format to Kong 3.x

    - publish: apis
      artifact: converted-apis

# ---------- Stage 3 Deploy ----------
- stage: Deploy
  dependsOn: Convert
  jobs:
  - job: DeployToKong
    steps:
    - download: current
      artifact: converted-apis

    - script: |
        echo "Deploying to Kong"
        deck gateway sync apis/demo-api.yaml
      displayName: Deploy APIs to Kong using decK
